name: Multi-Architecture CI/CD

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Test on multiple architectures using QEMU
  test-multi-arch:
    name: Test on ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        python-version: ['3.12', '3.13']
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up QEMU
      if: matrix.arch != 'amd64'
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ matrix.arch }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and test in container
      run: |
        cat > Dockerfile.test <<'EOF'
        ARG PYTHON_VERSION=3.11
        
        FROM python:${PYTHON_VERSION}-slim-bookworm
        
        # Install system dependencies
        RUN apt-get update && apt-get install -y \
            gcc \
            g++ \
            make \
            libffi-dev \
            libssl-dev \
            git \
            curl \
            && rm -rf /var/lib/apt/lists/*
        
        WORKDIR /app
        
        # Copy dependency files
        COPY requirements.txt setup.py pyproject.toml ./
        COPY ipfs_kit_py ipfs_kit_py/
        
        # Install dependencies
        RUN --mount=type=cache,target=/root/.cache/pip \
          pip install --upgrade pip setuptools wheel && \
          pip install -e .[dev,full,api] && \
          python -m ipfs_kit_py.zero_touch --binaries full

        # Ensure installed binaries are discoverable
        ENV PATH="/app/ipfs_kit_py/bin:${PATH}"
        
        # Copy test files
        COPY tests tests/
        COPY pytest.ini ./
        
        # Run tests (excluding integration tests)
        CMD ["python", "-m", "pytest", "tests/", "-v", "--tb=short", "-k", "not test_full", "-x", "--ignore=tests/test_mcp_restoration.py"]
        EOF
        
        docker buildx build \
          --platform linux/${{ matrix.arch }} \
          --build-arg PYTHON_VERSION=${{ matrix.python-version }} \
          -f Dockerfile.test \
          -t test-${{ matrix.arch }}:${{ matrix.python-version }} \
          --load \
          .
        
        docker run --rm test-${{ matrix.arch }}:${{ matrix.python-version }}
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.arch }}-py${{ matrix.python-version }}
        path: test-results/
        retention-days: 7

  # Native ARM64 testing on self-hosted runner
  test-arm64-native:
    name: Test on Native ARM64 (NVIDIA DGX)
    runs-on: [self-hosted, arm64]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        python-version: ['3.12', '3.13']
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Wait for package manager locks (if any)
      run: |
        echo "Checking for package manager locks..."
        timeout=300
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && \
             ! fuser /var/lib/dpkg/lock >/dev/null 2>&1 && \
             ! fuser /var/lib/apt/lists/lock >/dev/null 2>&1; then
            echo "No locks found"
            break
          fi
          echo "Waiting for locks to be released... ($elapsed/$timeout seconds)"
          sleep 5
          elapsed=$((elapsed + 5))
        done
        
        if [ $elapsed -ge $timeout ]; then
          echo "Warning: Timeout waiting for locks, proceeding anyway"
        fi
    
    - name: Install system dependencies
      run: |
        sudo apt-get update || true
        sudo apt-get install -y \
          gcc \
          g++ \
          make \
          libffi-dev \
          libssl-dev \
          git \
          curl \
          golang-go \
          pkg-config \
          wget \
          unzip \
          tar \
          gzip \
          || echo "Some system packages failed to install, continuing..."
    
    - name: Verify build tools
      run: |
        echo "Checking build tools availability..."
        go version || echo "⚠️  Go not available"
        make --version || echo "⚠️  Make not available"
        gcc --version || echo "⚠️  GCC not available"
        git --version || echo "⚠️  Git not available"
    
    - name: Zero-touch install (deps + binaries)
      run: |
        IPFS_KIT_EXTRAS=dev,full ./scripts/zero_touch_install.sh
    
    - name: Verify installations
      run: |
        source .venv/bin/activate
        echo "Checking installed packages..."
        pip list | grep -E "(libp2p|protobuf|eth-hash|eth-keys)" || echo "Some optional packages not installed"
        
        echo "Testing imports..."
        python -c "import ipfs_kit_py; print('✓ ipfs_kit_py imported')" || echo "✗ Failed to import ipfs_kit_py"
        python -c "from cryptography.fernet import Fernet; print('✓ cryptography available')" || echo "✗ cryptography not available"
        python -c "import multiaddr; print('✓ multiaddr available')" || echo "✗ multiaddr not available"
    
    - name: Run tests
      run: |
        source .venv/bin/activate
        python -m pytest tests/ -v --tb=short -k "not test_full" -x || true
      continue-on-error: true
    
    - name: Run ARM64 specific tests
      run: |
        source .venv/bin/activate
        if [ -f test_arm64_complete.py ]; then
          python test_arm64_complete.py || echo "ARM64 tests had issues"
        fi
        if [ -f test_arm64_installation.py ]; then
          python test_arm64_installation.py || echo "ARM64 installation tests had issues"
        fi
      continue-on-error: true
    
    - name: Generate test report
      if: always()
      run: |
        echo "## Test Summary for ARM64 Python ${{ matrix.python-version }}" > test-summary.md
        echo "" >> test-summary.md
        echo "- Platform: $(uname -m)" >> test-summary.md
        echo "- Python: ${{ matrix.python-version }}" >> test-summary.md
        echo "- Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> test-summary.md
        cat test-summary.md
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-arm64-native-py${{ matrix.python-version }}
        path: |
          test-summary.md
          test-results/
        retention-days: 7

  # Native AMD64 testing on self-hosted runner
  test-amd64-native:
    name: Test on Native AMD64 (x86_64)
    runs-on: [self-hosted, amd64]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        python-version: ['3.12', '3.13']
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Wait for package manager locks (if any)
      run: |
        echo "Checking for package manager locks..."
        timeout=300
        elapsed=0
        while [ $elapsed -lt $timeout ]; do
          if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && \
             ! fuser /var/lib/dpkg/lock >/dev/null 2>&1 && \
             ! fuser /var/lib/apt/lists/lock >/dev/null 2>&1; then
            echo "No locks found"
            break
          fi
          echo "Waiting for locks to be released... ($elapsed/$timeout seconds)"
          sleep 5
          elapsed=$((elapsed + 5))
        done
        
        if [ $elapsed -ge $timeout ]; then
          echo "Warning: Timeout waiting for locks, proceeding anyway"
        fi
    
    - name: Install system dependencies
      run: |
        sudo apt-get update || true
        sudo apt-get install -y \
          gcc \
          g++ \
          make \
          libffi-dev \
          libssl-dev \
          git \
          curl \
          golang-go \
          pkg-config \
          wget \
          unzip \
          tar \
          gzip \
          || echo "Some system packages failed to install, continuing..."
    
    - name: Verify build tools
      run: |
        echo "Checking build tools availability..."
        go version || echo "⚠️  Go not available"
        make --version || echo "⚠️  Make not available"
        gcc --version || echo "⚠️  GCC not available"
        git --version || echo "⚠️  Git not available"
    
    - name: Create virtual environment
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip setuptools wheel
    
    - name: Install dependencies
      run: |
        IPFS_KIT_EXTRAS=dev,full ./scripts/zero_touch_install.sh
    
    - name: Verify installations
      run: |
        source .venv/bin/activate
        echo "Checking installed packages..."
        pip list | grep -E "(libp2p|protobuf|eth-hash|eth-keys)" || echo "Some optional packages not installed"
        
        echo "Testing imports..."
        python -c "import ipfs_kit_py; print('✓ ipfs_kit_py imported')" || echo "✗ Failed to import ipfs_kit_py"
        python -c "from cryptography.fernet import Fernet; print('✓ cryptography available')" || echo "✗ cryptography not available"
        python -c "import multiaddr; print('✓ multiaddr available')" || echo "✗ multiaddr not available"
    
    - name: Run tests
      run: |
        source .venv/bin/activate
        python -m pytest tests/ -v --tb=short -k "not test_full" -x || true
      continue-on-error: true
    
    - name: Run AMD64 specific tests
      run: |
        source .venv/bin/activate
        if [ -f test_amd64_complete.py ]; then
          python test_amd64_complete.py || echo "AMD64 tests had issues"
        fi
        if [ -f test_amd64_installation.py ]; then
          python test_amd64_installation.py || echo "AMD64 installation tests had issues"
        fi
      continue-on-error: true
    
    - name: Generate test report
      if: always()
      run: |
        echo "## Test Summary for AMD64 Python ${{ matrix.python-version }}" > test-summary.md
        echo "" >> test-summary.md
        echo "- Platform: $(uname -m)" >> test-summary.md
        echo "- Python: ${{ matrix.python-version }}" >> test-summary.md
        echo "- Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> test-summary.md
        cat test-summary.md
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-amd64-native-py${{ matrix.python-version }}
        path: |
          test-summary.md
          test-results/
        retention-days: 7

  # Test on RISC-V using QEMU (experimental)
  test-riscv:
    name: Test on RISC-V (Experimental)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Only run manually
    strategy:
      matrix:
        python-version: ['3.12', '3.13']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up QEMU for RISC-V
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static binfmt-support
        
    - name: Test RISC-V compatibility
      run: |
        cat > Dockerfile.riscv <<'EOF'
        FROM riscv64/ubuntu:latest
        
        RUN apt-get update && apt-get install -y \
            python3 \
            python3-pip \
            python3-venv \
            gcc \
            g++ \
            make \
            && rm -rf /var/lib/apt/lists/*
        
        WORKDIR /app
        COPY . .
        
        RUN python3 -m pip install --upgrade pip setuptools wheel
        RUN python3 -m pip install -e . || echo "Main install failed"
        
        CMD ["python3", "-c", "import ipfs_kit_py; print('RISC-V: ipfs_kit_py imported successfully')"]
        EOF
        
        docker buildx build --platform linux/riscv64 \
          -f Dockerfile.riscv \
          -t test-riscv:latest \
          --load \
          . || echo "RISC-V build not fully supported yet"

  # Dependency verification job
  verify-dependencies:
    name: Verify Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Collect runtime diagnostics
      run: |
        set -euo pipefail
        mkdir -p dependency-report
        {
          echo "## Runtime diagnostics"
          echo
          echo "- Date (UTC): $(date -u +"%Y-%m-%d %H:%M:%S")"
          echo "- Kernel: $(uname -a)"
          echo "- Arch: $(uname -m)"
          echo
          echo "### OS"
          (cat /etc/os-release || true)
          echo
          echo "### Python"
          python -VV
          echo
          echo "### Pip"
          python -m pip --version
        } | tee dependency-report/runtime.md

        # Useful for understanding wheel tags / resolver behavior on different runners.
        python -m pip debug --verbose > dependency-report/pip-debug.txt || true

    - name: Verify installs in isolated environments
      run: |
        set -euo pipefail

        verify_env() {
          local name="$1"
          local extras="$2"
          local venv_dir=".venv-${name}"
          local out_dir="dependency-report/${name}"

          mkdir -p "$out_dir"
          python -m venv "$venv_dir"
          # shellcheck disable=SC1090
          source "$venv_dir/bin/activate"
          python -m pip install --upgrade pip setuptools wheel

          if [ -n "$extras" ]; then
            echo "Installing editable with extras: [$extras]" | tee "$out_dir/install.txt"
            python -m pip install -e ".[${extras}]" | tee -a "$out_dir/install.txt"
          else
            echo "Installing editable base package" | tee "$out_dir/install.txt"
            python -m pip install -e . | tee -a "$out_dir/install.txt"
          fi

          python -m pip list > "$out_dir/pip-list.txt"
          python -m pip freeze > "$out_dir/pip-freeze.txt"
          python -m pip check > "$out_dir/pip-check.txt" || true

          {
            python -c "import ipfs_kit_py; print('✓ ipfs_kit_py')"
            python -c "import multiaddr; print('✓ multiaddr')"
            python -c "import cryptography; print('✓ cryptography')"
          } > "$out_dir/imports-core.txt" || true

          deactivate
        }

        # Keep these separate so we catch resolver issues per extra set.
        verify_env "base" ""
        verify_env "libp2p" "libp2p"
        verify_env "full" "full"
        verify_env "dev_full" "dev,full"

    - name: Exercise zero-touch (runtime install path)
      id: zero_touch
      continue-on-error: true
      run: |
        set -euo pipefail
        mkdir -p dependency-report/zero-touch

        python -m venv .venv-zero-touch
        # shellcheck disable=SC1090
        source .venv-zero-touch/bin/activate
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install -e ".[dev,full]" | tee dependency-report/zero-touch/pip-install.txt

        # Default to safe behavior: do not attempt system-level dep installation.
        export IPFS_KIT_AUTO_INSTALL_DEPS=0
        export IPFS_KIT_AUTO_INSTALL_LOTUS_DEPS=0

        # Run the same entrypoint CI/Docker use; keep logs for diagnosis.
        python -m ipfs_kit_py.zero_touch --binaries full 2>&1 | tee dependency-report/zero-touch/zero-touch.log

    - name: Fail job if zero-touch failed
      if: steps.zero_touch.outcome != 'success'
      run: |
        echo "zero-touch install path failed; see dependency-report/zero-touch/zero-touch.log"
        exit 1
    
    - name: Upload dependency report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: dependency-report/
        retention-days: 7

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-multi-arch, test-arm64-native, test-amd64-native, verify-dependencies]
    if: always()
    
    steps:
    - name: Check test results
      run: |
        echo "Multi-architecture testing completed"
        echo "Check individual job results for details"
        echo ""
        echo "Self-hosted runner tests:"
        echo "- ARM64 native: ${{ needs.test-arm64-native.result }}"
        echo "- AMD64 native: ${{ needs.test-amd64-native.result }}"
