<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - IPFS Kit Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .data-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .search-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .cid-display {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .status-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
        }
        .car-archive-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
        }
        .sidebar {
            background: #f8f9fa;
            min-height: 100vh;
            border-right: 1px solid #dee2e6;
        }
        .nav-link.active {
            background: #007bff;
            color: white !important;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-3">
                <h5 class="mb-4">IPFS Kit Dashboard</h5>
                <nav class="nav flex-column">
                    <a class="nav-link {% if current_page == 'overview' %}active{% endif %}" href="/dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i>Overview
                    </a>
                    <a class="nav-link {% if current_page == 'vfs' %}active{% endif %}" href="/dashboard/vfs">
                        <i class="fas fa-database me-2"></i>Virtual Filesystem
                    </a>
                    <a class="nav-link {% if current_page == 'vector' %}active{% endif %}" href="/dashboard/vector">
                        <i class="fas fa-search me-2"></i>Vector Index
                    </a>
                    <a class="nav-link {% if current_page == 'knowledge-graph' %}active{% endif %}" href="/dashboard/knowledge-graph">
                        <i class="fas fa-project-diagram me-2"></i>Knowledge Graph
                    </a>
                    <a class="nav-link {% if current_page == 'pinset' %}active{% endif %}" href="/dashboard/pinset">
                        <i class="fas fa-thumbtack me-2"></i>Pinset Management
                    </a>
                    <a class="nav-link" href="/dashboard/health">
                        <i class="fas fa-heartbeat me-2"></i>System Health
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>{{ title }}</h2>
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <span class="text-muted" id="lastUpdated">Last updated: --</span>
                    </div>
                </div>

                <!-- VFS Dashboard Content -->
                <div class="row mb-4">
                    <!-- Metrics Cards -->
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="totalDatasets">--</div>
                            <div class="metric-label">Total Datasets</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="totalSize">--</div>
                            <div class="metric-label">Total Size (MB)</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="carArchives">--</div>
                            <div class="metric-label">CAR Archives</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="cacheHitRate">--%</div>
                            <div class="metric-label">Cache Hit Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="search-box">
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="datasetSearch" placeholder="Search datasets by name or CID...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="datasetFilter">
                                <option value="">All Datasets</option>
                                <option value="has_car">With CAR Archive</option>
                                <option value="has_vector">With Vector Index</option>
                                <option value="has_kg">With Knowledge Graph</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="searchDatasets()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Datasets Table -->
                <div class="data-table">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>CID</th>
                                    <th>Size</th>
                                    <th>Rows</th>
                                    <th>Columns</th>
                                    <th>Features</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="datasetsTable">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div>Loading datasets...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <nav class="mt-3">
                    <ul class="pagination justify-content-center" id="paginationControls">
                        <!-- Pagination will be inserted here -->
                    </ul>
                </nav>

                <!-- CAR Archives Section -->
                <div class="mt-5">
                    <h4 class="mb-3">CAR Archives</h4>
                    <div class="data-table">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Components</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="carArchivesTable">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div>Loading CAR archives...</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Convert to CAR Modal -->
    <div class="modal fade" id="convertToCarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Convert Dataset to CAR Archive</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="convertToCarForm">
                        <div class="mb-3">
                            <label class="form-label">Dataset CID</label>
                            <input type="text" class="form-control" id="convertCid" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Collection Name (Optional)</label>
                            <input type="text" class="form-control" id="collectionName" placeholder="Leave empty for auto-generated name">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="includeVectorIndex" checked>
                                <label class="form-check-label">Include Vector Index</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="includeKnowledgeGraph" checked>
                                <label class="form-check-label">Include Knowledge Graph</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="executeCarConversion()">Convert</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        const pageSize = 20;

        async function loadVFSData() {
            try {
                // Load summary metrics
                const summaryResponse = await fetch('/api/vfs/metadata/summary');
                const summaryData = await summaryResponse.json();
                
                if (summaryData.success) {
                    const summary = summaryData.summary;
                    document.getElementById('totalDatasets').textContent = summary.total_datasets;
                    document.getElementById('totalSize').textContent = summary.total_size_mb;
                    document.getElementById('carArchives').textContent = summary.car_archives_count;
                    document.getElementById('cacheHitRate').textContent = summary.cache_hit_rate + '%';
                }

                // Load datasets
                await loadDatasets();

                // Load CAR archives
                await loadCarArchives();

                document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();

            } catch (error) {
                console.error('Error loading VFS data:', error);
                showAlert('Error loading data: ' + error.message, 'danger');
            }
        }

        async function loadDatasets() {
            try {
                const response = await fetch(`/api/vfs/metadata/datasets?limit=${pageSize}&offset=${currentPage * pageSize}&include_car=true`);
                const data = await response.json();

                if (data.success) {
                    const tableBody = document.getElementById('datasetsTable');
                    tableBody.innerHTML = '';

                    if (data.datasets.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No datasets found</td></tr>';
                        return;
                    }

                    data.datasets.forEach(dataset => {
                        const row = document.createElement('tr');
                        
                        // Features badges
                        let features = [];
                        if (dataset.car_archive) {
                            features.push('<span class="car-archive-badge">CAR</span>');
                        }
                        if (dataset.metadata && dataset.metadata.has_vector_index) {
                            features.push('<span class="badge bg-success">Vector</span>');
                        }
                        if (dataset.metadata && dataset.metadata.has_knowledge_graph) {
                            features.push('<span class="badge bg-info">KG</span>');
                        }

                        row.innerHTML = `
                            <td>${dataset.name || 'Unnamed'}</td>
                            <td><span class="cid-display">${dataset.cid.substring(0, 16)}...</span></td>
                            <td>${formatBytes(dataset.size_bytes)}</td>
                            <td>${dataset.num_rows || '--'}</td>
                            <td>${dataset.num_columns || '--'}</td>
                            <td>${features.join(' ')}</td>
                            <td>${dataset.created_at ? new Date(dataset.created_at).toLocaleDateString() : '--'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewDataset('${dataset.cid}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="convertToCar('${dataset.cid}')">
                                        <i class="fas fa-archive"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="downloadParquet('${dataset.cid}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });

                    // Update pagination
                    updatePagination(data.pagination);
                }
            } catch (error) {
                console.error('Error loading datasets:', error);
                document.getElementById('datasetsTable').innerHTML = 
                    '<tr><td colspan="8" class="text-center py-4 text-danger">Error loading datasets</td></tr>';
            }
        }

        async function loadCarArchives() {
            try {
                const response = await fetch('/api/vfs/car-archives');
                const data = await response.json();

                if (data.success) {
                    const tableBody = document.getElementById('carArchivesTable');
                    tableBody.innerHTML = '';

                    if (data.archives.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No CAR archives found</td></tr>';
                        return;
                    }

                    data.archives.forEach(archive => {
                        const row = document.createElement('tr');
                        
                        // Components badges
                        let components = [];
                        if (archive.metadata && archive.metadata.components) {
                            const comp = archive.metadata.components;
                            if (comp.dataset) components.push('<span class="badge bg-primary">Dataset</span>');
                            if (comp.vector_index) components.push('<span class="badge bg-success">Vector</span>');
                            if (comp.knowledge_graph) components.push('<span class="badge bg-info">KG</span>');
                            if (comp.pinset) components.push('<span class="badge bg-warning">Pinset</span>');
                        }

                        row.innerHTML = `
                            <td>${archive.name}</td>
                            <td><span class="badge bg-secondary">${archive.type}</span></td>
                            <td>${formatBytes(archive.car_size || archive.size)}</td>
                            <td>${components.join(' ')}</td>
                            <td>${archive.metadata && archive.metadata.created_at ? 
                                new Date(archive.metadata.created_at).toLocaleDateString() : '--'}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="downloadCar('${archive.name}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="inspectCar('${archive.name}')">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading CAR archives:', error);
                document.getElementById('carArchivesTable').innerHTML = 
                    '<tr><td colspan="6" class="text-center py-4 text-danger">Error loading CAR archives</td></tr>';
            }
        }

        function updatePagination(pagination) {
            const controls = document.getElementById('paginationControls');
            controls.innerHTML = '';

            if (pagination.total <= pageSize) return;

            const totalPages = Math.ceil(pagination.total / pageSize);
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
            controls.appendChild(prevLi);

            // Page numbers
            for (let i = Math.max(0, currentPage - 2); i <= Math.min(totalPages - 1, currentPage + 2); i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i + 1}</a>`;
                controls.appendChild(pageLi);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
            controls.appendChild(nextLi);
        }

        function changePage(page) {
            if (page >= 0) {
                currentPage = page;
                loadDatasets();
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function convertToCar(cid) {
            document.getElementById('convertCid').value = cid;
            new bootstrap.Modal(document.getElementById('convertToCarModal')).show();
        }

        async function executeCarConversion() {
            try {
                const cid = document.getElementById('convertCid').value;
                const collectionName = document.getElementById('collectionName').value;
                const includeVector = document.getElementById('includeVectorIndex').checked;
                const includeKG = document.getElementById('includeKnowledgeGraph').checked;

                const params = new URLSearchParams({
                    include_vector_index: includeVector,
                    include_knowledge_graph: includeKG
                });

                if (collectionName) {
                    params.append('collection_name', collectionName);
                }

                const response = await fetch(`/api/vfs/metadata/convert-to-car?cid=${cid}&${params}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Dataset successfully converted to CAR archive', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('convertToCarModal')).hide();
                    loadCarArchives(); // Refresh CAR archives list
                } else {
                    showAlert('Conversion failed: ' + result.error, 'danger');
                }

            } catch (error) {
                console.error('Error converting to CAR:', error);
                showAlert('Conversion error: ' + error.message, 'danger');
            }
        }

        function downloadCar(identifier) {
            window.open(`/api/vfs/car-archives/${identifier}/download`, '_blank');
        }

        function showAlert(message, type) {
            // Simple alert - in production would use a proper notification system
            alert(message);
        }

        function refreshData() {
            loadVFSData();
        }

        function searchDatasets() {
            // Implement search functionality
            const searchTerm = document.getElementById('datasetSearch').value;
            const filter = document.getElementById('datasetFilter').value;
            // Reset to first page and reload with search parameters
            currentPage = 0;
            loadDatasets();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadVFSData();
            // Refresh every 30 seconds
            setInterval(loadVFSData, 30000);
        });
    </script>
</body>
</html>
