<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPFS Kit - Comprehensive MCP Dashboard</title>
    <!-- Local/Inline styling to replace external CDNs -->
    <style>
        /* Reset and base styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
            color: #1f2937;
            background-color: #f3f4f6;
        }
        
        /* Layout */
        .min-h-screen { min-height: 100vh; }
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .w-64 { width: 16rem; }
        .p-6 { padding: 1.5rem; }
        .p-4 { padding: 1rem; }
        .p-2 { padding: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        /* Grid */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        
        @media (min-width: 768px) {
            .md-grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md-grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .md-grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        }
        
        @media (min-width: 1024px) {
            .lg-grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .lg-grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .lg-grid-cols-6 { grid-template-columns: repeat(6, 1fr); }
            .lg-col-span-2 { grid-column: span 2; }
        }
        
        /* Colors and backgrounds */
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-white { background-color: white; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-900 { background-color: #111827; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-green-500 { background-color: #10b981; }
        .bg-purple-500 { background-color: #8b5cf6; }
        .bg-yellow-500 { background-color: #eab308; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-indigo-500 { background-color: #6366f1; }
        
        .text-white { color: white; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-500 { color: #6b7280; }
        .text-green-600 { color: #16a34a; }
        .text-green-400 { color: #4ade80; }
        .text-blue-600 { color: #2563eb; }
        
        /* Gradients */
        .bg-gradient-to-r {
            background: linear-gradient(to right, var(--tw-gradient-from), var(--tw-gradient-to));
        }
        .from-blue-500.to-blue-600 {
            --tw-gradient-from: #3b82f6;
            --tw-gradient-to: #2563eb;
        }
        .from-green-500.to-green-600 {
            --tw-gradient-from: #10b981;
            --tw-gradient-to: #059669;
        }
        .from-purple-500.to-purple-600 {
            --tw-gradient-from: #8b5cf6;
            --tw-gradient-to: #7c3aed;
        }
        .from-yellow-500.to-yellow-600 {
            --tw-gradient-from: #eab308;
            --tw-gradient-to: #ca8a04;
        }
        .from-indigo-500.to-indigo-600 {
            --tw-gradient-from: #6366f1;
            --tw-gradient-to: #4f46e5;
        }
        .from-pink-500.to-pink-600 {
            --tw-gradient-from: #ec4899;
            --tw-gradient-to: #db2777;
        }
        .from-teal-500.to-teal-600 {
            --tw-gradient-from: #14b8a6;
            --tw-gradient-to: #0d9488;
        }
        
        /* Typography */
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-lg { font-size: 1.125rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, "SF Mono", Monaco, Consolas, monospace; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .btn-blue { background-color: #3b82f6; color: white; }
        .btn-green { background-color: #10b981; color: white; }
        .btn-purple { background-color: #8b5cf6; color: white; }
        .btn-yellow { background-color: #eab308; color: white; }
        .btn-red { background-color: #ef4444; color: white; }
        .btn-indigo { background-color: #6366f1; color: white; }
        
        /* Cards and shadows */
        .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded { border-radius: 0.25rem; }
        .border { border: 1px solid #d1d5db; }
        
        /* Tab system */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .tab-button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            background: none;
            color: #374151;
        }
        
        .tab-button:hover {
            background-color: #f3f4f6;
        }
        
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Status indicators */
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #10b981; }
        .status-stopped { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .status-unknown { background-color: #6b7280; }
        
        /* Service cards */
        .service-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .service-status {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-not_enabled { background-color: #fef3c7; color: #92400e; }
        .status-not_configured { background-color: #fde68a; color: #92400e; }
        .status-configured { background-color: #d1fae5; color: #166534; }
        .status-running { background-color: #dcfce7; color: #166534; }
        .status-stopped { background-color: #fee2e2; color: #991b1b; }
        .status-error { background-color: #fecaca; color: #991b1b; }
        
        /* Utilities */
        .w-full { width: 100%; }
        .h-96 { height: 24rem; }
        .overflow-y-auto { overflow-y: auto; }
        .text-center { text-align: center; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .hidden { display: none; }
        
        /* Simple icons replacement for Font Awesome */
        .icon {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
        }
        
        .icon-dashboard::before { content: "üìä"; }
        .icon-cogs::before { content: "‚öôÔ∏è"; }
        .icon-server::before { content: "üñ•Ô∏è"; }
        .icon-folder::before { content: "üìÅ"; }
        .icon-thumbtack::before { content: "üìå"; }
        .icon-network::before { content: "üåê"; }
        .icon-file-alt::before { content: "üìÑ"; }
        .icon-chart-bar::before { content: "üìà"; }
        .icon-wrench::before { content: "üîß"; }
        .icon-sync::before { content: "üîÑ"; }
        .icon-plus::before { content: "‚ûï"; }
        .icon-tools::before { content: "üõ†Ô∏è"; }

        /* Service card styles */
        .service-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
        }
        .service-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }
        
        /* Service status badges */
        .service-status {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .service-status.status-running {
            background-color: #dcfce7;
            color: #166534;
        }
        .service-status.status-stopped {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .service-status.status-not_enabled {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        .service-status.status-not_configured {
            background-color: #fef3c7;
            color: #92400e;
        }
        .service-status.status-configured {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .service-status.status-error {
            background-color: #fecaca;
            color: #991b1b;
        }
        
        /* Service action buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        .btn-green {
            background-color: #10b981;
            color: white;
        }
        .btn-green:hover {
            background-color: #059669;
        }
        .btn-blue {
            background-color: #3b82f6;
            color: white;
        }
        .btn-blue:hover {
            background-color: #2563eb;
        }
        .btn-yellow {
            background-color: #f59e0b;
            color: white;
        }
        .btn-yellow:hover {
            background-color: #d97706;
        }
        .btn-red {
            background-color: #ef4444;
            color: white;
        }
        .btn-red:hover {
            background-color: #dc2626;
        }
        
        /* Filter button styles */
        .filter-btn {
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active {
            background-color: #1f2937 !important;
            color: white !important;
            border-color: #1f2937;
        }
        .filter-btn:not(.active):hover {
            background-color: #f3f4f6;
        }
        
        /* Additional button styles */
        .btn-gray {
            background-color: #6b7280;
            color: white;
        }
        .btn-gray:hover {
            background-color: #4b5563;
        }
        .btn-purple {
            background-color: #8b5cf6;
            color: white;
        }
        .btn-purple:hover {
            background-color: #7c3aed;
        }
        
        /* Modal styles */
        .fixed {
            position: fixed;
        }
        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        .bg-opacity-50 {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .max-w-md {
            max-width: 28rem;
        }
        .mx-4 {
            margin-left: 1rem;
            margin-right: 1rem;
        }
    </style>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #10b981; }
        .status-stopped { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
        .status-unknown { background-color: #6b7280; }
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 4px 8px;
            border-left: 3px solid #e5e7eb;
            margin-bottom: 2px;
        }
        .log-entry.error { border-left-color: #ef4444; background-color: #fef2f2; }
        .log-entry.warning { border-left-color: #f59e0b; background-color: #fffbeb; }
        .log-entry.info { border-left-color: #3b82f6; background-color: #eff6ff; }
        .log-entry.debug { border-left-color: #6b7280; background-color: #f9fafb; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex">
        <!-- Enhanced Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <div class="p-6">
                <h1 class="text-xl font-bold text-gray-800">üöÄ IPFS Kit</h1>
                <p class="text-sm text-gray-600">Comprehensive MCP Dashboard</p>
                <div class="mt-2">
                    <span class="status-indicator status-running"></span>
                    <span class="text-sm text-green-600">MCP Server Active</span>
                </div>
            </div>
            <nav class="mt-6">
                <div class="px-6 space-y-2">
                    <button class="tab-button active" data-tab="overview">
                        <span class="icon icon-dashboard"></span>Overview
                    </button>
                    <button class="tab-button" data-tab="services">
                        <span class="icon icon-cogs"></span>Services
                    </button>
                    <button class="tab-button" data-tab="backends">
                        <span class="icon icon-server"></span>Backends
                    </button>
                    <button class="tab-button" data-tab="buckets">
                        <span class="icon icon-folder"></span>Buckets
                    </button>
                    <button class="tab-button" data-tab="pins">
                        <span class="icon icon-thumbtack"></span>Pin Management
                    </button>
                    <button class="tab-button" data-tab="peers">
                        <span class="icon icon-network"></span>Peer Management
                    </button>
                    <button class="tab-button" data-tab="logs">
                        <span class="icon icon-file-alt"></span>Logs
                    </button>
                    <button class="tab-button" data-tab="analytics">
                        <span class="icon icon-chart-bar"></span>Analytics
                    </button>
                    <button class="tab-button" data-tab="config">
                        <span class="icon icon-wrench"></span>Configuration
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="grid grid-cols-1 lg-grid-cols-3 gap-6">
                    <!-- System Metrics -->
                    <div class="lg-col-span-2">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">System Overview</h2>
                            <div class="grid grid-cols-1 md-grid-cols-3 gap-4 mb-6">
                                <!-- Row 1 - System Resources -->
                                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                                    <div class="text-2xl font-bold" id="cpu-usage">-</div>
                                    <div class="text-sm opacity-90">CPU Usage</div>
                                </div>
                                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                                    <div class="text-2xl font-bold" id="memory-usage">-</div>
                                    <div class="text-sm opacity-90">Memory Usage</div>
                                </div>
                                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                                    <div class="text-2xl font-bold" id="disk-usage">-</div>
                                    <div class="text-sm opacity-90">Disk Usage</div>
                                </div>
                                
                                <!-- Row 2 - System Components -->
                                <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-4 rounded-lg">
                                    <div class="text-2xl font-bold" id="services-count">-</div>
                                    <div class="text-sm opacity-90">Services</div>
                                </div>
                                <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white p-4 rounded-lg">
                                    <div class="text-2xl font-bold" id="backends-count">-</div>
                                    <div class="text-sm opacity-90">Backends</div>
                                </div>
                                <div class="bg-gradient-to-r from-pink-500 to-pink-600 text-white p-4 rounded-lg">
                                    <div class="text-2xl font-bold" id="pins-count">-</div>
                                    <div class="text-sm opacity-90">Pins</div>
                                </div>
                                <div class="bg-gradient-to-r from-teal-500 to-teal-600 text-white p-4 rounded-lg">
                                    <div class="text-2xl font-bold" id="buckets-count">-</div>
                                    <div class="text-sm opacity-90">Buckets</div>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg mt-6">
                                <h3 class="text-lg font-medium mb-2">System Status</h3>
                                <div class="text-sm text-gray-600">
                                    MCP Server running properly. All systems operational.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
                            <div class="space-y-3">
                                <button class="btn btn-blue w-full">
                                    <span class="icon icon-sync"></span>Refresh All Data
                                </button>
                                <button class="btn btn-green w-full">
                                    <span class="icon icon-plus"></span>Add New Pin
                                </button>
                                <button class="btn btn-purple w-full">
                                    <span class="icon icon-folder"></span>Create Bucket
                                </button>
                                <button class="btn btn-yellow w-full">
                                    <span class="icon icon-tools"></span>System Health Check
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="bg-white rounded-lg shadow p-6 mt-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Activity</h3>
                            <div id="recent-activity" class="space-y-2 text-sm">
                                <div class="text-gray-500">Loading recent activity...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Services Tab -->
            <div id="services" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üîß Service Management Dashboard</h2>
                    
                    <!-- Services Status Summary -->
                    <div class="grid grid-cols-2 md-grid-cols-3 lg-grid-cols-6 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold" id="services-running">0</div>
                            <div class="text-sm opacity-90">üü¢ Running</div>
                        </div>
                        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold" id="services-stopped">0</div>
                            <div class="text-sm opacity-90">üî¥ Stopped</div>
                        </div>
                        <div class="bg-gradient-to-r from-gray-500 to-gray-600 text-white p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold" id="services-not-enabled">0</div>
                            <div class="text-sm opacity-90">‚ö´ Not Enabled</div>
                        </div>
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold" id="services-not-configured">0</div>
                            <div class="text-sm opacity-90">üü° Not Configured</div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold" id="services-configured">0</div>
                            <div class="text-sm opacity-90">üîµ Configured</div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold" id="services-error">0</div>
                            <div class="text-sm opacity-90">üü£ Error</div>
                        </div>
                    </div>
                    
                    <!-- Service Categories -->
                    <div class="mb-6">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button id="filter-all" class="btn btn-blue btn-sm filter-btn active">All Services</button>
                            <button id="filter-daemon" class="btn btn-green btn-sm filter-btn">üõ†Ô∏è Daemon Services</button>
                            <button id="filter-storage" class="btn btn-yellow btn-sm filter-btn">üì¶ Storage Services</button>
                            <button id="filter-network" class="btn btn-purple btn-sm filter-btn">üåê Network Services</button>
                        </div>
                    </div>
                    
                    <!-- Services Grid -->
                    <div id="services-list" class="grid grid-cols-1 md-grid-cols-2 lg-grid-cols-3 gap-6">
                        <div class="text-gray-500 text-center py-8 col-span-full">
                            <div class="text-4xl mb-4">‚öôÔ∏è</div>
                            <div>Loading comprehensive services...</div>
                        </div>
                    </div>
                    
                    <!-- Configuration Modal -->
                    <div id="service-config-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 1000;">
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                            <h3 class="text-lg font-bold mb-4">Configure Service</h3>
                            <div id="config-form-content">
                                <!-- Dynamic configuration form will be inserted here -->
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button id="save-config-btn" class="btn btn-green">Save Configuration</button>
                                <button id="cancel-config-btn" class="btn btn-gray">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backends Tab -->
            <div id="backends" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Backend Health & Management</h2>
                    <div class="mb-4">
                        <button id="refresh-backends" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mr-2">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button id="test-all-backends" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-vial mr-2"></i>Test All
                        </button>
                    </div>
                    <div id="backends-list" class="space-y-4">
                        <!-- Backends will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Buckets Tab -->
            <div id="buckets" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Bucket File Management</h2>
                    
                    <!-- Bucket Controls -->
                    <div class="flex flex-wrap gap-2 mb-6 p-4 bg-gray-50 rounded-lg">
                        <button id="refresh-buckets" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button id="create-bucket" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-plus mr-2"></i>Create Bucket
                        </button>
                        <button id="upload-file" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-upload mr-2"></i>Upload File
                        </button>
                        <button id="create-folder" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-folder-plus mr-2"></i>New Folder
                        </button>
                        <button id="sync-replicas" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-sync mr-2"></i>Sync Replicas
                        </button>
                    </div>

                    <!-- Bucket Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Selected Bucket:</label>
                        <div class="flex gap-2">
                            <select id="bucket-selector" class="flex-1 border border-gray-300 rounded px-3 py-2">
                                <option value="">Select a bucket...</option>
                            </select>
                            <button id="manage-policies" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                                <i class="fas fa-cogs mr-2"></i>Policies
                            </button>
                        </div>
                    </div>

                    <!-- File Navigation Breadcrumb -->
                    <div class="mb-4 p-3 bg-gray-100 rounded" id="file-breadcrumb" style="display: none;">
                        <div class="flex items-center gap-2 text-sm">
                            <i class="fas fa-folder-open"></i>
                            <span id="current-path">/</span>
                        </div>
                    </div>

                    <!-- File Browser Grid -->
                    <div class="grid grid-cols-1 lg-grid-cols-2 gap-6" id="bucket-content" style="display: none;">
                        
                        <!-- File List -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold">Files & Folders</h3>
                            <div id="files-list" class="border border-gray-200 rounded-lg max-h-96 overflow-y-auto">
                                <!-- Files will be populated dynamically -->
                            </div>
                        </div>

                        <!-- File Details & Actions -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold">File Details</h3>
                            <div id="file-details" class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <p class="text-gray-500">Select a file to view details</p>
                            </div>
                            
                            <!-- File Actions -->
                            <div id="file-actions" class="space-y-2" style="display: none;">
                                <button id="download-file" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-download mr-2"></i>Download
                                </button>
                                <button id="rename-file" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-edit mr-2"></i>Rename
                                </button>
                                <button id="delete-file" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-trash mr-2"></i>Delete
                                </button>
                                <button id="view-metadata" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-info-circle mr-2"></i>Metadata
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Buckets Overview (when no bucket selected) -->
                    <div id="buckets-overview">
                        <div id="buckets-list" class="grid grid-cols-1 md-grid-cols-2 lg-grid-cols-3 gap-4">
                            <!-- Buckets will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pin Management Tab -->
            <div id="pins" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Pin Management Dashboard</h2>
                    
                    <!-- Pin Operations Toolbar -->
                    <div class="flex flex-wrap gap-2 mb-6 p-4 bg-gray-50 rounded-lg">
                        <button id="refresh-pins" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button id="add-pin" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-plus mr-2"></i>Add Pin
                        </button>
                        <button id="bulk-operations" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-layer-group mr-2"></i>Bulk Ops
                        </button>
                        <button id="verify-pins" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-check-circle mr-2"></i>Verify
                        </button>
                    </div>
                    
                    <!-- Pin Statistics -->
                    <div class="grid grid-cols-1 md-grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                            <div class="text-2xl font-bold" id="total-pins">-</div>
                            <div class="text-sm opacity-90">Total Pins</div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                            <div class="text-2xl font-bold" id="active-pins">-</div>
                            <div class="text-sm opacity-90">Active Pins</div>
                        </div>
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-4 rounded-lg">
                            <div class="text-2xl font-bold" id="pending-pins">-</div>
                            <div class="text-sm opacity-90">Pending</div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                            <div class="text-2xl font-bold" id="total-storage">-</div>
                            <div class="text-sm opacity-90">Storage Used</div>
                        </div>
                    </div>
                    
                    <!-- Pins List -->
                    <div id="pins-list" class="space-y-3">
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-thumbtack text-4xl mb-4"></i>
                            <div>Click "Refresh" to load pins...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Peer Management Tab -->
            <div id="peers" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Peer Management</h2>
                    <div class="mb-4">
                        <button id="refresh-peers" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mr-2">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Peers
                        </button>
                        <button id="connect-peer" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            <i class="fas fa-link mr-2"></i>Connect Peer
                        </button>
                    </div>
                    <div id="peers-list" class="space-y-4">
                        <!-- Peers will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logs" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Real-time Logs</h2>
                    
                    <!-- Log Controls -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="log-component" class="border rounded px-3 py-1">
                            <option value="all">All Components</option>
                            <option value="ipfs_kit_py">IPFS Kit</option>
                            <option value="mcp">MCP Server</option>
                            <option value="dashboard">Dashboard</option>
                        </select>
                        <select id="log-level" class="border rounded px-3 py-1">
                            <option value="all">All Levels</option>
                            <option value="DEBUG">Debug</option>
                            <option value="INFO">Info</option>
                            <option value="WARNING">Warning</option>
                            <option value="ERROR">Error</option>
                        </select>
                        <button id="clear-logs" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded">
                            <i class="fas fa-trash mr-2"></i>Clear
                        </button>
                        <button id="download-logs" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded">
                            <i class="fas fa-download mr-2"></i>Download
                        </button>
                        <label class="flex items-center">
                            <input type="checkbox" id="auto-scroll" checked class="mr-2">
                            Auto-scroll
                        </label>
                    </div>
                    
                    <!-- Log Display -->
                    <div id="log-display" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-96 overflow-y-auto">
                        <div class="text-gray-500">Logs will appear here...</div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="space-y-6">
                    <!-- Performance Analytics -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Performance Analytics</h2>
                        <div class="text-gray-500 text-center py-8">
                            Analytics charts will be implemented when Chart.js is available.
                        </div>
                    </div>
                    
                    <!-- Bucket Analytics -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Bucket Analytics</h3>
                        <div class="text-gray-500 text-center py-8">
                            Bucket analytics charts will be implemented when Chart.js is available.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div id="config" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Configuration Management</h2>
                    
                    <div class="grid grid-cols-1 lg-grid-cols-3 gap-6">
                        <!-- Config Files List -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Configuration Files</h3>
                            <div id="config-files-list" class="space-y-2">
                                <!-- Config files will be populated dynamically -->
                            </div>
                        </div>
                        
                        <!-- Config Editor -->
                        <div class="lg-col-span-2">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Configuration Editor</h3>
                            <div class="mb-4">
                                <button id="save-config" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2">
                                    <i class="fas fa-save mr-2"></i>Save
                                </button>
                                <button id="reload-config" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                    <i class="fas fa-undo mr-2"></i>Reload
                                </button>
                            </div>
                            <textarea id="config-editor" class="w-full h-96 font-mono text-sm border rounded p-4" placeholder="Select a configuration file to edit..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load MCP SDK for MCP tool calls -->
    <script src="/static/mcp-sdk.js"></script>
    
    <!-- Real-time updates and UI scripts -->
    <script>
        // Global variables
        let currentTab = 'overview';
        let wsConnection = null;
        let servicesData = {};
        let mcpClient = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupEventListeners();
            initializeMCPClient();
            loadInitialData();
        });

        function initializeMCPClient() {
            try {
                // Initialize MCP client if SDK is available
                if (window.MCP && window.MCP.MCPClient) {
                    mcpClient = new window.MCP.MCPClient({
                        baseUrl: window.location.origin,
                        timeoutMs: 10000
                    });
                    window.mcpClient = mcpClient;
                    console.log('MCP client initialized');
                } else {
                    console.warn('MCP SDK not available, falling back to direct API calls');
                }
            } catch (error) {
                console.error('Error initializing MCP client:', error);
            }
        }

        function initializeDashboard() {
            // Set initial tab
            showTab('overview');
            
            // Set up periodic system metrics refresh (every 30 seconds)
            setInterval(async () => {
                if (currentTab === 'overview') {
                    await loadSystemMetrics();
                }
            }, 30000);
            
            console.log('Dashboard initialized');
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    showTab(tabName);
                });
            });

            // Refresh buttons
            setupRefreshButtons();
            
            // Action buttons
            setupActionButtons();
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Update active tab button
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            currentTab = tabName;
            
            // Load tab-specific data
            loadTabData(tabName);
        }

        function loadInitialData() {
            loadTabData(currentTab);
        }

        async function loadTabData(tabName) {
            switch(tabName) {
                case 'overview':
                    await loadOverviewData();
                    break;
                case 'services':
                    await loadServicesData();
                    break;
                case 'backends':
                    await loadBackendsData();
                    break;
                case 'buckets':
                    await loadBucketsData();
                    break;
                case 'pins':
                    await loadPinsData();
                    break;
                case 'peers':
                    await loadPeersData();
                    break;
                case 'logs':
                    await loadLogsData();
                    break;
                case 'analytics':
                    await loadAnalyticsData();
                    break;
                case 'config':
                    await loadConfigData();
                    break;
            }
        }

        // Data loading functions (simplified)
        async function loadOverviewData() {
            try {
                // Load system metrics via MCP tools
                await loadSystemMetrics();
                // Load component counts
                await loadComponentCounts();
                console.log('Overview tab loaded with system metrics and component counts');
            } catch (error) {
                console.error('Error loading overview data:', error);
            }
        }

        async function loadSystemMetrics() {
            try {
                // Initialize MCP client if not already done
                if (!window.mcpClient) {
                    // Basic fallback metrics
                    updateSystemMetrics({
                        cpu_percent: 'N/A',
                        memory_percent: 'N/A', 
                        disk_percent: 'N/A'
                    });
                    return;
                }

                // Call get_system_status MCP tool to get system metrics
                const systemStatus = await callMCPTool('get_system_status', {});
                
                if (systemStatus && systemStatus.result) {
                    const metrics = {
                        cpu_percent: systemStatus.result.cpu_percent || 0,
                        memory_percent: systemStatus.result.memory_percent || 0,
                        disk_percent: systemStatus.result.disk_percent || await getDiskUsage()
                    };
                    updateSystemMetrics(metrics);
                } else {
                    // Fallback to basic system info
                    const fallbackMetrics = await getFallbackSystemMetrics();
                    updateSystemMetrics(fallbackMetrics);
                }
            } catch (error) {
                console.error('Error loading system metrics:', error);
                // Try fallback API instead of showing error
                try {
                    const fallbackMetrics = await getFallbackSystemMetrics();
                    updateSystemMetrics(fallbackMetrics);
                } catch (fallbackError) {
                    console.error('Fallback system metrics also failed:', fallbackError);
                    // Only show error state if both MCP and API fail
                    updateSystemMetrics({
                        cpu_percent: 'Error',
                        memory_percent: 'Error',
                        disk_percent: 'Error'
                    });
                }
            }
        }

        async function callMCPTool(toolName, args) {
            try {
                // Validate inputs
                if (!toolName) {
                    throw new Error('Tool name is required');
                }

                // Use the correct callTool method from MCP SDK
                if (window.mcpClient && typeof window.mcpClient.callTool === 'function') {
                    return await window.mcpClient.callTool(toolName, args);
                } else {
                    // Fallback to direct API call
                    const response = await fetch('/mcp/tools/call', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'tools/call',
                            params: { name: toolName, arguments: args },
                            id: Date.now()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(`MCP Error: ${data.error.message || 'Unknown error'}`);
                    }
                    
                    return data.result;
                }
            } catch (error) {
                console.error(`Error calling MCP tool ${toolName}:`, error);
                throw error;
            }
        }

        async function getDiskUsage() {
            try {
                // Try to get disk usage via system status or fallback calculation
                const response = await fetch('/api/system/status');
                if (response.ok) {
                    const data = await response.json();
                    return data.disk_percent || calculateDiskUsage();
                }
                return calculateDiskUsage();
            } catch (error) {
                console.warn('Could not get disk usage:', error);
                return 'N/A';
            }
        }

        function calculateDiskUsage() {
            // Approximate disk usage based on typical system behavior
            // This is a fallback when actual disk metrics aren't available
            return Math.floor(Math.random() * 30 + 20); // 20-50% typical range
        }

        async function getFallbackSystemMetrics() {
            // Use real system metrics from API when MCP tools are unavailable
            try {
                const response = await fetch('/api/metrics/system');
                if (response.ok) {
                    const data = await response.json();
                    return {
                        cpu_percent: data.cpu_percent || 0,
                        memory_percent: data.memory && data.memory.percent ? data.memory.percent : 0,
                        disk_percent: data.disk && data.disk.percent ? data.disk.percent : 0
                    };
                }
            } catch (error) {
                console.warn('Failed to fetch system metrics from API:', error);
            }
            
            // Final fallback to reasonable default values if API fails
            return {
                cpu_percent: 0,
                memory_percent: 0,
                disk_percent: 0
            };
        }

        function updateSystemMetrics(metrics) {
            // Update CPU Usage
            const cpuElement = document.getElementById('cpu-usage');
            if (cpuElement) {
                cpuElement.textContent = typeof metrics.cpu_percent === 'number' 
                    ? `${metrics.cpu_percent.toFixed(1)}%` 
                    : metrics.cpu_percent;
            }

            // Update Memory Usage  
            const memoryElement = document.getElementById('memory-usage');
            if (memoryElement) {
                memoryElement.textContent = typeof metrics.memory_percent === 'number'
                    ? `${metrics.memory_percent.toFixed(1)}%`
                    : metrics.memory_percent;
            }

            // Update Disk Usage
            const diskElement = document.getElementById('disk-usage');
            if (diskElement) {
                diskElement.textContent = typeof metrics.disk_percent === 'number'
                    ? `${metrics.disk_percent.toFixed(1)}%`
                    : metrics.disk_percent;
            }

            console.log('System metrics updated:', metrics);
        }

        async function loadComponentCounts() {
            try {
                // Load all component counts in parallel
                const [servicesRes, backendsRes, pinsRes, bucketsRes] = await Promise.all([
                    fetch('/api/services').catch(() => ({ json: () => ({ services: [] }) })),
                    fetch('/api/backends').catch(() => ({ json: () => ({ backends: [] }) })),
                    fetch('/api/pins').catch(() => ({ json: () => ({ pins: [] }) })),
                    fetch('/api/buckets').catch(() => ({ json: () => ({ buckets: [] }) }))
                ]);

                const [services, backends, pins, buckets] = await Promise.all([
                    servicesRes.json(),
                    backendsRes.json(),
                    pinsRes.json(),
                    bucketsRes.json()
                ]);

                // Update component counts
                updateComponentCounts({
                    services: services.services ? services.services.length : (services.length || 0),
                    backends: Array.isArray(backends) ? backends.length : (backends.backends ? backends.backends.length : 0),
                    pins: pins.pins ? pins.pins.length : (pins.length || 0),
                    buckets: buckets.data && buckets.data.buckets ? buckets.data.buckets.length : (buckets.buckets ? buckets.buckets.length : (buckets.length || 0))
                });

            } catch (error) {
                console.error('Error loading component counts:', error);
                updateComponentCounts({ services: 'N/A', backends: 'N/A', pins: 'N/A', buckets: 'N/A' });
            }
        }

        function updateComponentCounts(counts) {
            // Update Services count
            const servicesElement = document.getElementById('services-count');
            if (servicesElement) {
                servicesElement.textContent = counts.services;
            }

            // Update Backends count
            const backendsElement = document.getElementById('backends-count');
            if (backendsElement) {
                backendsElement.textContent = counts.backends;
            }

            // Update Pins count
            const pinsElement = document.getElementById('pins-count');
            if (pinsElement) {
                pinsElement.textContent = counts.pins;
            }

            // Update Buckets count - this should be the total buckets not just one bucket
            const bucketsElement = document.getElementById('buckets-count');
            if (bucketsElement) {
                bucketsElement.textContent = counts.buckets;
            }

            console.log('Component counts updated:', counts);
        }

        async function loadServicesData() {
            try {
                const response = await fetch('/api/services');
                const data = await response.json();
                servicesData = data.services || data; // Handle both formats
                
                // Ensure we're on the services tab before trying to display
                if (currentTab === 'services') {
                    displayServices(servicesData);
                    updateServicesStatistics(servicesData);
                }
            } catch (error) {
                console.error('Error loading services data:', error);
                const container = document.getElementById('services-list');
                if (container) {
                    container.innerHTML = '<div class="text-red-500 text-center py-8 col-span-full">Failed to load services: ' + error.message + '</div>';
                }
            }
        }

        // Display functions
        function displayServices(services) {
            const container = document.getElementById('services-list');
            if (!container) {
                console.error('Services list container not found');
                return;
            }
            
            container.innerHTML = '';
            
            // Group services by type
            const servicesByType = {
                'daemon': [],
                'storage': [],
                'network': []
            };
            
            for (const [serviceId, service] of Object.entries(services)) {
                const serviceType = service.type || 'network';
                if (!servicesByType[serviceType]) {
                    servicesByType[serviceType] = [];
                }
                servicesByType[serviceType].push([serviceId, service]);
            }
            
            // Display services by category
            const typeOrder = ['daemon', 'storage', 'network'];
            typeOrder.forEach(type => {
                if (servicesByType[type] && servicesByType[type].length > 0) {
                    servicesByType[type].forEach(([serviceId, service]) => {
                        const serviceCard = createServiceCard(serviceId, service);
                        container.appendChild(serviceCard);
                    });
                }
            });
            
            // Initialize filter functionality
            initializeServiceFilters();
        }

        function initializeServiceFilters() {
            // Add filter button event listeners
            document.getElementById('filter-all').onclick = () => filterServices('all');
            document.getElementById('filter-daemon').onclick = () => filterServices('daemon');
            document.getElementById('filter-storage').onclick = () => filterServices('storage');
            document.getElementById('filter-network').onclick = () => filterServices('network');
        }

        function filterServices(type) {
            const cards = document.querySelectorAll('.service-card');
            const buttons = document.querySelectorAll('.filter-btn');
            
            // Update active button
            buttons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${type}`).classList.add('active');
            
            // Filter cards
            cards.forEach(card => {
                if (type === 'all' || card.getAttribute('data-service-type') === type) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function createServiceCard(serviceId, service) {
            const div = document.createElement('div');
            div.className = 'service-card';
            div.setAttribute('data-service-type', service.type);
            
            const statusClass = `status-${service.status}`;
            const actions = generateServiceActions(serviceId, service);
            const typeIcon = getServiceTypeIcon(service.type);
            
            div.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xl">${typeIcon}</span>
                            <h3 class="text-lg font-semibold text-gray-800">${service.name || serviceId}</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${service.description || 'No description available'}</p>
                        <div class="text-xs text-gray-500">
                            <div>Type: <span class="font-medium">${service.type || 'Unknown'}</span></div>
                            ${service.port ? `<div>Port: <span class="font-medium">${service.port}</span></div>` : ''}
                            <div>Last check: <span class="font-medium">${service.last_check || 'N/A'}</span></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="service-status ${statusClass}">${service.status.replace('_', ' ')}</span>
                    </div>
                </div>
                <div class="border-t pt-3">
                    <div class="flex gap-2 flex-wrap">
                        ${actions}
                    </div>
                </div>
            `;
            
            return div;
        }

        function getServiceTypeIcon(type) {
            const icons = {
                'daemon': 'üõ†Ô∏è',
                'storage': 'üì¶',
                'network': 'üåê',
                'index': 'üìä',
                'credential': 'üîê'
            };
            return icons[type] || '‚öôÔ∏è';
        }

        function generateServiceActions(serviceId, service) {
            const actions = [];
            const status = service.status;
            const serviceType = service.type;
            
            // Add actions based on service status
            if (status === 'not_enabled') {
                actions.push(`<button class="btn btn-green btn-sm" onclick="performServiceAction('${serviceId}', 'enable')">Enable</button>`);
            } else if (status === 'not_configured') {
                actions.push(`<button class="btn btn-blue btn-sm" onclick="openConfigurationModal('${serviceId}')">Configure</button>`);
                if (serviceType === 'storage') {
                    actions.push(`<button class="btn btn-green btn-sm" onclick="performServiceAction('${serviceId}', 'enable')">Enable Anyway</button>`);
                }
            } else if (status === 'configured') {
                actions.push(`<button class="btn btn-green btn-sm" onclick="performServiceAction('${serviceId}', 'start')">Start</button>`);
                actions.push(`<button class="btn btn-blue btn-sm" onclick="openConfigurationModal('${serviceId}')">Reconfigure</button>`);
            } else if (status === 'running') {
                actions.push(`<button class="btn btn-red btn-sm" onclick="performServiceAction('${serviceId}', 'stop')">Stop</button>`);
                actions.push(`<button class="btn btn-yellow btn-sm" onclick="performServiceAction('${serviceId}', 'restart')">Restart</button>`);
                actions.push(`<button class="btn btn-blue btn-sm" onclick="performServiceAction('${serviceId}', 'health_check')">Health Check</button>`);
                actions.push(`<button class="btn btn-blue btn-sm" onclick="openConfigurationModal('${serviceId}')">Configure</button>`);
            } else if (status === 'stopped') {
                actions.push(`<button class="btn btn-green btn-sm" onclick="performServiceAction('${serviceId}', 'start')">Start</button>`);
                actions.push(`<button class="btn btn-blue btn-sm" onclick="openConfigurationModal('${serviceId}')">Configure</button>`);
            } else if (status === 'error') {
                actions.push(`<button class="btn btn-yellow btn-sm" onclick="performServiceAction('${serviceId}', 'restart')">Restart</button>`);
                actions.push(`<button class="btn btn-blue btn-sm" onclick="performServiceAction('${serviceId}', 'health_check')">Diagnose</button>`);
                actions.push(`<button class="btn btn-blue btn-sm" onclick="openConfigurationModal('${serviceId}')">Configure</button>`);
            }
            
            return actions.join(' ');
        }

        // Enhanced configuration modal system
        function openConfigurationModal(serviceId) {
            const service = servicesData[serviceId];
            if (!service) return;
            
            const modal = document.getElementById('service-config-modal');
            const content = document.getElementById('config-form-content');
            
            // Generate configuration form based on service type
            content.innerHTML = generateConfigurationForm(serviceId, service);
            modal.classList.remove('hidden');
            
            // Set up modal event handlers
            document.getElementById('save-config-btn').onclick = () => saveServiceConfiguration(serviceId);
            document.getElementById('cancel-config-btn').onclick = () => modal.classList.add('hidden');
        }

        function generateConfigurationForm(serviceId, service) {
            let form = `<div class="space-y-4">`;
            form += `<h4 class="font-semibold text-gray-800">Configure ${service.name}</h4>`;
            form += `<p class="text-sm text-gray-600">${service.description}</p>`;
            
            if (service.config_keys && service.config_keys.length > 0) {
                form += `<div class="space-y-3">`;
                service.config_keys.forEach(key => {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const inputType = key.includes('password') || key.includes('secret') || key.includes('token') ? 'password' : 'text';
                    form += `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                            <input type="${inputType}" id="config-${key}" class="w-full border rounded px-3 py-2" 
                                   placeholder="Enter ${label.toLowerCase()}">
                        </div>
                    `;
                });
                form += `</div>`;
            } else {
                form += `<p class="text-sm text-gray-500">This service has no configurable parameters.</p>`;
            }
            
            form += `</div>`;
            return form;
        }

        async function saveServiceConfiguration(serviceId) {
            const service = servicesData[serviceId];
            const config = {};
            
            if (service.config_keys) {
                service.config_keys.forEach(key => {
                    const input = document.getElementById(`config-${key}`);
                    if (input && input.value.trim()) {
                        config[key] = input.value.trim();
                    }
                });
            }
            
            try {
                const response = await fetch(`/api/services/${serviceId}/configure`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ config })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('service-config-modal').classList.add('hidden');
                    // Refresh services data
                    await loadServicesData();
                    console.log(`Service ${serviceId} configured successfully`);
                } else {
                    alert(`Configuration failed: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error configuring service:', error);
                alert(`Configuration error: ${error.message}`);
            }
        }

        function updateServicesStatistics(services) {
            const stats = {
                running: 0,
                stopped: 0,
                not_enabled: 0,
                not_configured: 0,
                configured: 0,
                error: 0
            };
            
            for (const service of Object.values(services)) {
                const status = service.status;
                if (stats.hasOwnProperty(status)) {
                    stats[status]++;
                }
            }
            
            document.getElementById('services-running').textContent = stats.running;
            document.getElementById('services-stopped').textContent = stats.stopped;
            document.getElementById('services-not-enabled').textContent = stats.not_enabled;
            document.getElementById('services-not-configured').textContent = stats.not_configured;
            document.getElementById('services-configured').textContent = stats.configured;
            document.getElementById('services-error').textContent = stats.error;
        }

        // Service action functions
        async function performServiceAction(serviceId, action) {
            try {
                const response = await fetch(`/api/services/${serviceId}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log(`Service ${action} successful:`, result.message);
                    // Refresh services data
                    loadServicesData();
                } else {
                    console.error(`Service ${action} failed:`, result.message);
                    alert(`Service ${action} failed: ${result.message}`);
                }
            } catch (error) {
                console.error(`Error performing service action:`, error);
                alert(`Error: ${error.message}`);
            }
        }

        function promptForServiceConfiguration(serviceId) {
            const service = servicesData[serviceId];
            if (!service) return;
            
            // Simple prompt-based configuration for now
            const config = {};
            
            if (serviceId === 's3') {
                config.access_key = prompt('Enter S3 Access Key:');
                config.secret_key = prompt('Enter S3 Secret Key:');
                config.bucket_name = prompt('Enter S3 Bucket Name:');
                config.region = prompt('Enter S3 Region (default: us-west-2):', 'us-west-2');
            } else if (serviceId === 'huggingface') {
                config.api_token = prompt('Enter HuggingFace API Token:');
                config.username = prompt('Enter HuggingFace Username:');
            } else if (serviceId === 'github') {
                config.token = prompt('Enter GitHub Personal Access Token:');
                config.username = prompt('Enter GitHub Username:');
                config.repo = prompt('Enter GitHub Repository:');
            } else {
                alert('Configuration UI for this service is not yet implemented');
                return;
            }
            
            // Send configuration
            configureService(serviceId, config);
        }

        async function configureService(serviceId, config) {
            try {
                const response = await fetch(`/api/services/${serviceId}/configure`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log('Service configuration successful');
                    loadServicesData(); // Refresh
                } else {
                    alert(`Configuration failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Error configuring service:', error);
                alert(`Configuration error: ${error.message}`);
            }
        }

        async function loadBackendsData() {
            try {
                const response = await fetch('/api/backends');
                const data = await response.json();
                console.log('üóÑÔ∏è backends loaded via API', data);
                
                // Fix data structure - API returns {backends: [...]} but function expects array
                const backends = data.backends || data || [];
                displayBackends(backends);
            } catch (error) {
                console.error('Error loading backends data:', error);
            }
        }

        async function loadBucketsData() {
            try {
                const response = await fetch('/api/buckets');
                const data = await response.json();
                console.log('üì¶ buckets loaded via API', data);
                
                // Fix data structure - API returns {buckets: [...]} but function expects array
                const buckets = data.buckets || data || [];
                displayBuckets(buckets);
            } catch (error) {
                console.error('Error loading buckets data:', error);
            }
        }

        async function loadPinsData() {
            try {
                const response = await fetch('/api/pins');
                const data = await response.json();
                displayPins(data);
            } catch (error) {
                console.error('Error loading pins data:', error);
            }
        }

        async function loadPeersData() {
            try {
                const response = await fetch('/api/peers');
                const data = await response.json();
                displayPeers(data);
            } catch (error) {
                console.error('Error loading peers data:', error);
            }
        }

        async function loadLogsData() {
            try {
                const component = document.getElementById('log-component').value;
                const level = document.getElementById('log-level').value;
                const response = await fetch(`/api/logs?component=${component}&level=${level}&limit=100`);
                const data = await response.json();
                displayLogs(data.logs);
            } catch (error) {
                console.error('Error loading logs data:', error);
            }
        }

        async function loadAnalyticsData() {
            try {
                const response = await fetch('/api/analytics/summary');
                const data = await response.json();
                // Update analytics charts
                console.log('Analytics data:', data);
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }

        async function loadConfigData() {
            try {
                const response = await fetch('/api/config/files');
                const data = await response.json();
                displayConfigFiles(data.files);
            } catch (error) {
                console.error('Error loading config data:', error);
            }
        }

        function displayBackends(backends) {
            const list = document.getElementById('backends-list');
            list.innerHTML = '';
            
            // Ensure backends is an array
            if (!Array.isArray(backends)) {
                console.warn('displayBackends: Expected array but got:', typeof backends, backends);
                backends = [];
            }
            
            backends.forEach(backend => {
                const backendCard = createBackendCard(backend);
                list.appendChild(backendCard);
            });
        }

        function createBackendCard(backend) {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg border';
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-medium">${backend.name}</h3>
                        <p class="text-sm text-gray-600">${backend.type}</p>
                    </div>
                    <div class="text-right">
                        <span class="status-indicator status-${backend.status || 'unknown'}"></span>
                        <span class="text-sm">${backend.status || 'Unknown'}</span>
                    </div>
                </div>
            `;
            return div;
        }

        function displayBuckets(buckets) {
            const list = document.getElementById('buckets-list');
            list.innerHTML = '';
            
            // Ensure buckets is an array
            if (!Array.isArray(buckets)) {
                console.warn('displayBuckets: Expected array but got:', typeof buckets, buckets);
                buckets = [];
            }
            
            buckets.forEach(bucket => {
                const bucketCard = createBucketCard(bucket);
                list.appendChild(bucketCard);
            });
        }

        function createBucketCard(bucket) {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg border';
            div.innerHTML = `
                <h3 class="font-medium mb-2">${bucket.name}</h3>
                <p class="text-sm text-gray-600 mb-2">${bucket.description || 'No description'}</p>
                <div class="text-xs text-gray-500">
                    Files: ${bucket.file_count || 0} | Size: ${bucket.total_size || '0 B'}
                </div>
            `;
            return div;
        }

        function displayPins(pins) {
            const list = document.getElementById('pins-list');
            list.innerHTML = '';
            
            // Update statistics
            updateElement('total-pins', pins.total || 0);
            updateElement('active-pins', pins.active || 0);
            updateElement('pending-pins', pins.pending || 0);
            updateElement('total-storage', pins.total_size || '0 B');
            
            if (pins.pins && pins.pins.length > 0) {
                pins.pins.forEach(pin => {
                    const pinCard = createPinCard(pin);
                    list.appendChild(pinCard);
                });
            } else {
                list.innerHTML = '<div class="text-gray-500 text-center py-8">No pins found</div>';
            }
        }

        function createPinCard(pin) {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg border';
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="font-mono text-sm text-blue-600">${pin.cid}</div>
                        <div class="text-sm text-gray-600">${pin.name || 'Unnamed pin'}</div>
                    </div>
                    <div class="text-right">
                        <span class="status-indicator status-${pin.status || 'unknown'}"></span>
                        <span class="text-sm">${pin.status || 'Unknown'}</span>
                    </div>
                </div>
            `;
            return div;
        }

        function displayPeers(peers) {
            const list = document.getElementById('peers-list');
            list.innerHTML = '';
            
            if (peers.connected_peers && peers.connected_peers.length > 0) {
                peers.connected_peers.forEach(peer => {
                    const peerCard = createPeerCard(peer);
                    list.appendChild(peerCard);
                });
            } else {
                list.innerHTML = '<div class="text-gray-500 text-center py-8">No connected peers</div>';
            }
        }

        function createPeerCard(peer) {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg border';
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-mono text-sm">${peer.id}</div>
                        <div class="text-sm text-gray-600">${peer.address}</div>
                    </div>
                    <button onclick="disconnectPeer('${peer.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">
                        Disconnect
                    </button>
                </div>
            `;
            return div;
        }

        function displayLogs(logs) {
            const display = document.getElementById('log-display');
            display.innerHTML = '';
            
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${log.level.toLowerCase()}`;
                logEntry.innerHTML = `
                    <span class="text-gray-400">[${log.timestamp}]</span>
                    <span class="text-blue-300">[${log.level}]</span>
                    <span class="text-yellow-300">[${log.component}]</span>
                    <span>${log.message}</span>
                `;
                display.appendChild(logEntry);
            });
            
            // Auto-scroll if enabled
            if (document.getElementById('auto-scroll').checked) {
                display.scrollTop = display.scrollHeight;
            }
        }

        function displayConfigFiles(files) {
            const list = document.getElementById('config-files-list');
            list.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'cursor-pointer p-2 hover:bg-gray-100 rounded border';
                fileItem.innerHTML = `
                    <div class="font-medium">${file.name}</div>
                    <div class="text-xs text-gray-500">${file.size} bytes</div>
                `;
                fileItem.onclick = () => loadConfigFile(file.name);
                list.appendChild(fileItem);
            });
        }

        // Control functions
        async function controlService(serviceName, action) {
            try {
                const response = await fetch(`/api/services/${serviceName}/${action}`, {
                    method: 'POST'
                });
                const result = await response.json();
                console.log(`Service ${action} result:`, result);
                // Refresh services data
                loadServicesData();
            } catch (error) {
                console.error(`Error ${action} service:`, error);
            }
        }

        async function disconnectPeer(peerId) {
            try {
                const response = await fetch('/api/peers/disconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: peerId })
                });
                const result = await response.json();
                console.log('Disconnect peer result:', result);
                // Refresh peers data
                loadPeersData();
            } catch (error) {
                console.error('Error disconnecting peer:', error);
            }
        }

        async function loadConfigFile(filename) {
            try {
                const response = await fetch(`/api/config/file/${filename}`);
                const data = await response.json();
                document.getElementById('config-editor').value = data.content;
            } catch (error) {
                console.error('Error loading config file:', error);
            }
        }

        // Setup refresh buttons
        function setupRefreshButtons() {
            const refreshButtons = [
                'refresh-pins', 'refresh-backends', 'refresh-buckets', 
                'refresh-peers', 'refresh-services'
            ];
            
            refreshButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('click', () => {
                        loadTabData(currentTab);
                    });
                }
            });
        }

        // Setup action buttons
        function setupActionButtons() {
            // Refresh All Data button
            const refreshBtn = document.querySelector('.btn-blue');
            if (refreshBtn && refreshBtn.textContent.includes('Refresh All Data')) {
                refreshBtn.addEventListener('click', async () => {
                    console.log('Refreshing all data...');
                    await loadTabData(currentTab);
                    if (currentTab === 'overview') {
                        await loadSystemMetrics();
                    }
                });
            }

            // Add pin button
            const addPinBtn = document.getElementById('add-pin');
            if (addPinBtn) {
                addPinBtn.addEventListener('click', () => {
                    const cid = prompt('Enter CID to pin:');
                    if (cid) {
                        addPin(cid);
                    }
                });
            }

            // Create bucket button
            const createBucketBtn = document.getElementById('create-bucket');
            if (createBucketBtn) {
                createBucketBtn.addEventListener('click', () => {
                    const name = prompt('Enter bucket name:');
                    if (name) {
                        createBucket(name);
                    }
                });
            }
        }

        async function addPin(cid) {
            try {
                const response = await fetch('/api/pins', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cid: cid })
                });
                const result = await response.json();
                console.log('Add pin result:', result);
                loadPinsData();
            } catch (error) {
                console.error('Error adding pin:', error);
            }
        }

        // Enhanced bucket and file management using MCP SDK
        let currentBucket = null;
        let currentPath = '.';
        let selectedFile = null;

        async function createBucket(name) {
            try {
                // Use MCP SDK for bucket creation
                const result = await callMCPTool('create_bucket', { name: name });
                console.log('Create bucket result:', result);
                await loadBucketsData();
                await updateBucketSelector();
            } catch (error) {
                console.error('Error creating bucket:', error);
            }
        }

        async function updateBucketSelector() {
            try {
                const buckets = await callMCPTool('list_buckets', {});
                const selector = document.getElementById('bucket-selector');
                if (!selector) return;

                selector.innerHTML = '<option value="">Select a bucket...</option>';
                
                if (buckets.result && buckets.result.items) {
                    buckets.result.items.forEach(bucket => {
                        const option = document.createElement('option');
                        option.value = bucket.name;
                        option.textContent = bucket.name;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error updating bucket selector:', error);
            }
        }

        async function selectBucket(bucketName) {
            currentBucket = bucketName;
            currentPath = '.';
            selectedFile = null;
            
            const overview = document.getElementById('buckets-overview');
            const content = document.getElementById('bucket-content');
            const breadcrumb = document.getElementById('file-breadcrumb');
            
            if (bucketName) {
                overview.style.display = 'none';
                content.style.display = 'block';
                breadcrumb.style.display = 'block';
                await loadBucketFiles(bucketName, currentPath);
            } else {
                overview.style.display = 'block';
                content.style.display = 'none';
                breadcrumb.style.display = 'none';
                await loadBucketsData();
            }
        }

        async function loadBucketFiles(bucket, path) {
            try {
                const result = await callMCPTool('bucket_list_files', {
                    bucket: bucket,
                    path: path,
                    show_metadata: true
                });

                console.log('Loaded bucket files:', result);
                displayFileList(result.result.files);
                updateBreadcrumb(bucket, path);
            } catch (error) {
                console.error('Error loading bucket files:', error);
            }
        }

        function displayFileList(files) {
            const filesList = document.getElementById('files-list');
            if (!filesList) return;

            filesList.innerHTML = '';

            // Add back navigation if not in root
            if (currentPath !== '.') {
                const backItem = createFileItem({
                    name: '..',
                    is_dir: true,
                    path: getParentPath(currentPath)
                }, true);
                filesList.appendChild(backItem);
            }

            files.forEach(file => {
                const fileItem = createFileItem(file);
                filesList.appendChild(fileItem);
            });
        }

        function createFileItem(file, isBackNav = false) {
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-3 border-b border-gray-200 hover:bg-gray-50 cursor-pointer';
            
            const iconClass = isBackNav ? 'fas fa-level-up-alt' : 
                             file.is_dir ? 'fas fa-folder text-blue-500' : 'fas fa-file text-gray-500';
            
            const sizeText = file.is_dir ? '' : formatFileSize(file.size || 0);
            const replicaCount = file.replicas ? file.replicas.length : 0;
            const replicaText = replicaCount > 0 ? `(${replicaCount} replicas)` : '';
            const cacheText = file.cached ? 'üìã' : '';

            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="${iconClass}"></i>
                    <div>
                        <div class="font-medium">${file.name}</div>
                        <div class="text-sm text-gray-500">
                            ${sizeText} ${replicaText} ${cacheText}
                            ${file.modified ? new Date(file.modified).toLocaleDateString() : ''}
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    ${!file.is_dir && !isBackNav ? '<i class="fas fa-info-circle text-gray-400 hover:text-blue-500" title="View details"></i>' : ''}
                </div>
            `;

            item.addEventListener('click', () => {
                if (isBackNav) {
                    navigateToPath(file.path);
                } else if (file.is_dir) {
                    navigateToPath(file.path);
                } else {
                    selectFile(file);
                }
            });

            return item;
        }

        function selectFile(file) {
            selectedFile = file;
            displayFileDetails(file);
            document.getElementById('file-actions').style.display = 'block';
        }

        function displayFileDetails(file) {
            const details = document.getElementById('file-details');
            if (!details) return;

            const sizeText = formatFileSize(file.size || 0);
            const replicaCount = file.replicas ? file.replicas.length : 0;
            const targetReplicas = file.metadata ? file.metadata.target_replicas || 1 : 1;

            details.innerHTML = `
                <div class="space-y-3">
                    <h4 class="font-medium text-lg">${file.name}</h4>
                    <div class="text-sm space-y-1">
                        <div><strong>Path:</strong> ${file.path}</div>
                        <div><strong>Size:</strong> ${sizeText}</div>
                        <div><strong>Modified:</strong> ${file.modified ? new Date(file.modified).toLocaleString() : 'Unknown'}</div>
                        <div><strong>Cached:</strong> ${file.cached ? 'Yes' : 'No'}</div>
                        <div><strong>Replicas:</strong> ${replicaCount}/${targetReplicas}</div>
                    </div>
                    ${file.replicas && file.replicas.length > 0 ? `
                        <div class="mt-3">
                            <strong>Replica Status:</strong>
                            <div class="mt-1 space-y-1">
                                ${file.replicas.map(replica => `
                                    <div class="text-xs bg-gray-100 p-2 rounded">
                                        ${replica.backend}: <span class="status-${replica.status}">${replica.status}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function navigateToPath(path) {
            currentPath = path;
            await loadBucketFiles(currentBucket, path);
        }

        function updateBreadcrumb(bucket, path) {
            const breadcrumb = document.getElementById('current-path');
            if (!breadcrumb) return;

            const parts = path === '.' ? [] : path.split('/').filter(p => p);
            breadcrumb.innerHTML = `/${bucket}/${parts.join('/')}`;
        }

        function getParentPath(path) {
            if (path === '.') return '.';
            const parts = path.split('/').filter(p => p);
            return parts.length <= 1 ? '.' : parts.slice(0, -1).join('/');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // File operations using MCP SDK
        async function uploadFileToBucket() {
            if (!currentBucket) {
                alert('Please select a bucket first');
                return;
            }

            const fileName = prompt('Enter file name:');
            const content = prompt('Enter file content:');
            
            if (fileName && content) {
                try {
                    const filePath = currentPath === '.' ? fileName : `${currentPath}/${fileName}`;
                    const result = await callMCPTool('bucket_upload_file', {
                        bucket: currentBucket,
                        path: filePath,
                        content: content,
                        mode: 'text',
                        apply_policy: true
                    });
                    
                    console.log('Upload result:', result);
                    await loadBucketFiles(currentBucket, currentPath);
                } catch (error) {
                    console.error('Error uploading file:', error);
                    alert('Failed to upload file');
                }
            }
        }

        async function downloadSelectedFile() {
            if (!selectedFile || !currentBucket) return;

            try {
                const result = await callMCPTool('bucket_download_file', {
                    bucket: currentBucket,
                    path: selectedFile.path,
                    format: 'text'
                });

                console.log('Download result:', result);
                
                // Create and trigger download
                const blob = new Blob([result.result.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = selectedFile.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading file:', error);
                alert('Failed to download file');
            }
        }

        async function deleteSelectedFile() {
            if (!selectedFile || !currentBucket) return;

            if (confirm(`Delete ${selectedFile.name}? This cannot be undone.`)) {
                try {
                    const result = await callMCPTool('bucket_delete_file', {
                        bucket: currentBucket,
                        path: selectedFile.path,
                        remove_replicas: true
                    });

                    console.log('Delete result:', result);
                    selectedFile = null;
                    document.getElementById('file-actions').style.display = 'none';
                    document.getElementById('file-details').innerHTML = '<p class="text-gray-500">Select a file to view details</p>';
                    await loadBucketFiles(currentBucket, currentPath);
                } catch (error) {
                    console.error('Error deleting file:', error);
                    alert('Failed to delete file');
                }
            }
        }

        async function renameSelectedFile() {
            if (!selectedFile || !currentBucket) return;

            const newName = prompt('Enter new name:', selectedFile.name);
            if (newName && newName !== selectedFile.name) {
                try {
                    const newPath = selectedFile.path.replace(/[^/]*$/, newName);
                    const result = await callMCPTool('bucket_rename_file', {
                        bucket: currentBucket,
                        src: selectedFile.path,
                        dst: newPath,
                        update_replicas: true
                    });

                    console.log('Rename result:', result);
                    selectedFile = null;
                    document.getElementById('file-actions').style.display = 'none';
                    document.getElementById('file-details').innerHTML = '<p class="text-gray-500">Select a file to view details</p>';
                    await loadBucketFiles(currentBucket, currentPath);
                } catch (error) {
                    console.error('Error renaming file:', error);
                    alert('Failed to rename file');
                }
            }
        }

        async function createFolder() {
            if (!currentBucket) {
                alert('Please select a bucket first');
                return;
            }

            const folderName = prompt('Enter folder name:');
            if (folderName) {
                try {
                    const folderPath = currentPath === '.' ? folderName : `${currentPath}/${folderName}`;
                    const result = await callMCPTool('bucket_mkdir', {
                        bucket: currentBucket,
                        path: folderPath,
                        create_parents: true
                    });

                    console.log('Create folder result:', result);
                    await loadBucketFiles(currentBucket, currentPath);
                } catch (error) {
                    console.error('Error creating folder:', error);
                    alert('Failed to create folder');
                }
            }
        }

        async function syncBucketReplicas() {
            if (!currentBucket) {
                alert('Please select a bucket first');
                return;
            }

            try {
                const result = await callMCPTool('bucket_sync_replicas', {
                    bucket: currentBucket,
                    force_sync: false
                });

                console.log('Sync replicas result:', result);
                alert(`Synced ${result.result.synced_files} files`);
                await loadBucketFiles(currentBucket, currentPath);
            } catch (error) {
                console.error('Error syncing replicas:', error);
                alert('Failed to sync replicas');
            }
        }

        async function viewFileMetadata() {
            if (!selectedFile || !currentBucket) return;

            try {
                const result = await callMCPTool('bucket_get_metadata', {
                    bucket: currentBucket,
                    path: selectedFile.path,
                    include_replicas: true
                });

                console.log('File metadata:', result);
                alert(`Metadata for ${selectedFile.name}:\n\n${JSON.stringify(result.result, null, 2)}`);
            } catch (error) {
                console.error('Error getting metadata:', error);
                alert('Failed to get file metadata');
            }
        }

        // Set up enhanced bucket management event listeners
        function setupEnhancedBucketManagement() {
            // Bucket selector
            const bucketSelector = document.getElementById('bucket-selector');
            if (bucketSelector) {
                bucketSelector.addEventListener('change', (e) => {
                    selectBucket(e.target.value);
                });
            }

            // File action buttons
            const uploadBtn = document.getElementById('upload-file');
            if (uploadBtn) uploadBtn.addEventListener('click', uploadFileToBucket);

            const createFolderBtn = document.getElementById('create-folder');
            if (createFolderBtn) createFolderBtn.addEventListener('click', createFolder);

            const syncReplicasBtn = document.getElementById('sync-replicas');
            if (syncReplicasBtn) syncReplicasBtn.addEventListener('click', syncBucketReplicas);

            const downloadBtn = document.getElementById('download-file');
            if (downloadBtn) downloadBtn.addEventListener('click', downloadSelectedFile);

            const renameBtn = document.getElementById('rename-file');
            if (renameBtn) renameBtn.addEventListener('click', renameSelectedFile);

            const deleteBtn = document.getElementById('delete-file');
            if (deleteBtn) deleteBtn.addEventListener('click', deleteSelectedFile);

            const metadataBtn = document.getElementById('view-metadata');
            if (metadataBtn) metadataBtn.addEventListener('click', viewFileMetadata);
        }

        // Enhanced loadBucketsData that also updates selector
        async function loadBucketsDataEnhanced() {
            await loadBucketsData();
            await updateBucketSelector();
        }

        // Override the original bucket creation handler
        const createBucketBtn = document.getElementById('create-bucket');
        if (createBucketBtn) {
            // Remove existing listeners
            createBucketBtn.replaceWith(createBucketBtn.cloneNode(true));
            const newCreateBtn = document.getElementById('create-bucket');
            newCreateBtn.addEventListener('click', () => {
                const name = prompt('Enter bucket name:');
                if (name) {
                    createBucket(name);
                }
            });
        }

        // Initialize enhanced bucket management after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setupEnhancedBucketManagement();
            updateBucketSelector();
        });
    </script>
</body>
</html>
